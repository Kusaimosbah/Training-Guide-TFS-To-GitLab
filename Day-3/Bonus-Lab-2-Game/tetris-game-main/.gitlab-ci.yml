# ============================================
# Bonus Lab 2 - Web-Based Tetris Game CI/CD Pipeline
# ============================================
# Deploys game to GitLab Pages for live playability

stages:
  - validate
  - test
  - deploy

variables:
  ARTIFACT_RETENTION: "7 days"

# ============================================
# VALIDATE STAGE - Verify file structure
# ============================================
validate:files:
  stage: validate
  image: alpine:latest
  tags:
    - kusai
  script:
    - echo "üîç Validating project files..."
    - test -f index.html && echo "‚úÖ index.html found" || (echo "‚ùå index.html missing" && exit 1)
    - test -f game.js && echo "‚úÖ game.js found" || (echo "‚ùå game.js missing" && exit 1)
    - test -f style.css && echo "‚úÖ style.css found" || (echo "‚ùå style.css missing" && exit 1)
    - echo "‚úÖ All core files present"
  only:
    - main
    - merge_requests
    - branches

# ============================================
# TEST STAGE - Check HTML/CSS/JS integrity
# ============================================
test:html:
  stage: test
  image: alpine:latest
  tags:
    - kusai
  script:
    - echo "üß™ Testing HTML structure..."
    - grep -q "<!DOCTYPE html>" index.html && echo "‚úÖ Valid HTML5 doctype" || echo "‚ö†Ô∏è Missing doctype"
    - grep -q "<title>Tetris Game</title>" index.html && echo "‚úÖ Title present" || echo "‚ö†Ô∏è Missing title"
    - grep -q 'id="game"' index.html && echo "‚úÖ Game container found" || (echo "‚ùå Game container missing" && exit 1)
    - echo "‚úÖ HTML validation passed"
  only:
    - main
    - merge_requests
    - branches

test:javascript:
  stage: test
  image: node:18-alpine
  tags:
    - kusai
  script:
    - echo "üß™ Testing JavaScript syntax..."
    - node -c game.js && echo "‚úÖ JavaScript syntax valid" || (echo "‚ùå JavaScript syntax error" && exit 1)
    - grep -q "class Block" game.js && echo "‚úÖ Block class found" || echo "‚ö†Ô∏è Block class missing"
    - grep -q "class TetrisGame" game.js && echo "‚úÖ TetrisGame class found" || echo "‚ö†Ô∏è TetrisGame class missing"
    - echo "‚úÖ JavaScript validation passed"
  only:
    - main
    - merge_requests
    - branches

test:css:
  stage: test
  image: alpine:latest
  tags:
    - kusai
  script:
    - echo "üß™ Testing CSS styling..."
    - grep -q ".cell" style.css && echo "‚úÖ Cell styling found" || echo "‚ö†Ô∏è Cell styling missing"
    - grep -q ".block-T" style.css && echo "‚úÖ Block styles found" || echo "‚ö†Ô∏è Block styles missing"
    - test $(grep -c "background:" style.css) -ge 7 && echo "‚úÖ All piece colors defined" || echo "‚ö†Ô∏è Missing color definitions"
    - echo "‚úÖ CSS validation passed"
  only:
    - main
    - merge_requests
    - branches

# ============================================
# DEPLOY STAGE - Deploy to GitLab Pages
# ============================================
pages:
  stage: deploy
  image: alpine:latest
  tags:
    - kusai
  script: |
    echo "üöÄ Deploying to GitLab Pages..."
    mkdir -p public
    cp index.html public/
    cp game.js public/
    cp style.css public/
    echo "üìù Creating deployment info..."
    echo "Game deployed: $(date)" > public/DEPLOYED.txt
    echo "Commit: $CI_COMMIT_SHA" >> public/DEPLOYED.txt
    echo "Branch: $CI_COMMIT_REF_NAME" >> public/DEPLOYED.txt
    echo "‚úÖ Deployment complete!"
    ls -la public/
  artifacts:
    paths:
      - public
  only:
    - main

# ============================================
# NOTES
# ============================================
# GitLab Pages Configuration:
# - Game is deployed to: public/ directory
# - Automatically hosted at: https://{user}.gitlab.io/{project}/
# - Accessible after pipeline success on main branch
# - No manual deployment needed
# - Live game playable in browser
# ============================================
