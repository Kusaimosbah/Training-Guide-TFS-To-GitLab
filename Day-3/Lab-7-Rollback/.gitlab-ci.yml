# ============================================
# GitLab CI/CD Pipeline for Lab 7 - Rollback & Recovery
# ============================================
# Demonstrates deployment with rollback capabilities
# Pipeline stages: BUILD → TEST → DEPLOY → ROLLBACK (manual)
# Includes backup creation and version tracking for safe rollbacks
# ============================================

# Define pipeline stages
stages:
  - build      # First: Compile and publish
  - test       # Second: Run tests
  - deploy     # Third: Deploy to staging with backup
  - rollback   # Fourth: Manual rollback if needed

# Global variables
variables:
  DOTNET_VERSION: "8.0"                          # .NET SDK version
  DOTNET_CLI_TELEMETRY_OPTOUT: "true"           # Disable telemetry
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"     # Skip welcome
  DOTNET_NOLOGO: "true"                         # Hide logo
  APP_VERSION: "1.0.0"                          # Application version

# ============================================
# BUILD JOB - Compile and publish
# ============================================
build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0        # .NET 8 SDK
  script:
    - echo "Building application version $APP_VERSION..."
    - dotnet restore src/WebApi/WebApi.csproj    # Restore packages
    - dotnet build src/WebApi/WebApi.csproj --configuration Release --no-restore
    - dotnet publish src/WebApi/WebApi.csproj -c Release -o ./publish --no-restore
    - echo "Build completed!"
  artifacts:                                      # Save published files
    paths:
      - publish/                                 # Published app directory
    expire_in: 1 week                           # Keep for 1 week
  only:
    - main
    - branches

# ============================================
# TEST JOB - Verify quality
# ============================================
test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - echo "Running unit tests..."
    - dotnet restore tests/StatusApi.Tests/StatusApi.Tests.csproj
    - echo "Installing JUnit logger for test reports..."
    - dotnet add tests/StatusApi.Tests/StatusApi.Tests.csproj package JunitXml.TestLogger
    - dotnet test tests/StatusApi.Tests/StatusApi.Tests.csproj --configuration Release --logger "console;verbosity=detailed" --logger "junit;LogFileName=test-results.xml"
    - echo "Tests passed!"
  artifacts:
    when: always
    paths:
      - tests/StatusApi.Tests/TestResults/test-results.xml
    reports:
      junit: tests/StatusApi.Tests/TestResults/test-results.xml
    expire_in: 7 days
  dependencies:
    - build
  only:
    - main
    - branches

# ============================================
# DEPLOY JOB - Deploy with backup
# ============================================
# Deployment script creates automatic backup before deploying
# Backup is stored for potential rollback
# Version information is tracked in staging-version.txt
# ============================================
deploy:staging:
  stage: deploy
  image: mcr.microsoft.com/powershell:latest     # PowerShell container
  script:
    - echo "Deploying version $APP_VERSION to staging..."
    # Deploy script creates backup automatically
    - pwsh deploy.ps1 -Version $APP_VERSION -SourcePath "./publish" -StagingPath "./deployments/staging"
    - echo "Deployment completed! Version info:"
    # Display deployed version
    - cat deployments/staging/staging-version.txt || echo "Version file not found"
  artifacts:                                      # Save deployment artifacts
    paths:
      - deployments/staging/                     # Current deployment
      - deployments/staging-backup/              # Backup for rollback
    expire_in: 1 month                          # Keep for 1 month
  environment:                                   # Environment tracking
    name: staging
    url: https://staging.example.com
  dependencies:
    - build
  only:
    - main

# ============================================
# ROLLBACK JOB - Restore previous version (MANUAL TRIGGER)
# ============================================
# This job is triggered MANUALLY when issues are detected
# Restores the backup created during previous deployment
# Use this when new deployment has critical issues
# ============================================
rollback:staging:
  stage: rollback
  image: mcr.microsoft.com/powershell:latest
  script:
    - echo "⚠️ INITIATING ROLLBACK TO PREVIOUS VERSION..."
    # Restore backup to staging directory
    # -StagingPath: Current deployment location
    # -BackupPath: Location of backup to restore
    - pwsh rollback.ps1 -StagingPath "./deployments/staging" -BackupPath "./deployments/staging-backup"
    - echo "Rollback completed! Restored version:"
    # Display restored version
    - cat deployments/staging/staging-version.txt || echo "Version file not found"
  artifacts:
    paths:
      - deployments/staging/
    expire_in: 1 month
  environment:
    name: staging
    url: https://staging.example.com
  when: manual
  only:
    - main
  needs:
    - deploy:staging
