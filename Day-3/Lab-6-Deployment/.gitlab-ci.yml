# ============================================
# GitLab CI/CD Pipeline for Lab 6 - Deployment Automation
# ============================================
# Demonstrates automated deployment using PowerShell scripts
# Pipeline stages: BUILD → TEST → DEPLOY
# Uses deployment scripts for consistent, repeatable deployments
# ============================================

# Define pipeline stages
stages:
  - build      # First: Compile and publish
  - test       # Second: Run tests
  - deploy     # Third: Deploy to staging

# Global variables
variables:
  DOTNET_VERSION: "8.0"                          # .NET SDK version
  DOTNET_CLI_TELEMETRY_OPTOUT: "true"           # Disable telemetry
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"     # Skip welcome
  DOTNET_NOLOGO: "true"                         # Hide logo
  APP_VERSION: "1.0.0"                          # Application version

# ============================================
# BUILD JOB - Compile and publish
# ============================================
build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0        # .NET 8 SDK
  script:
    - echo "Building application..."
    - dotnet restore src/WebApi/WebApi.csproj    # Restore packages
    - dotnet build src/WebApi/WebApi.csproj --configuration Release --no-restore
    - echo "Publishing application..."
    - dotnet publish src/WebApi/WebApi.csproj -c Release -o ./publish --no-restore
    - echo "Build and publish completed!"
  artifacts:                                      # Save published files
    paths:
      - publish/                                 # Published app directory
    expire_in: 1 week                           # Keep for 1 week
  only:
    - main
    - merge_requests
    - branches

# ============================================
# TEST JOB - Verify quality
# ============================================
test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - echo "Running unit tests..."
    - dotnet restore tests/StatusApi.Tests/StatusApi.Tests.csproj
    - echo "Installing JUnit logger for test reports..."
    - dotnet add tests/StatusApi.Tests/StatusApi.Tests.csproj package JunitXml.TestLogger
    - dotnet test tests/StatusApi.Tests/StatusApi.Tests.csproj --configuration Release --logger "console;verbosity=detailed" --logger "junit;LogFileName=test-results.xml"
    - echo "Tests passed!"
  artifacts:
    when: always
    paths:
      - tests/StatusApi.Tests/TestResults/test-results.xml
    reports:
      junit: tests/StatusApi.Tests/TestResults/test-results.xml
    expire_in: 7 days
  dependencies:
    - build
  only:
    - main
    - merge_requests
    - branches

# ============================================
# DEPLOY JOB - Automated deployment using PowerShell
# ============================================
# Uses PowerShell script (deploy.ps1) for deployment
# Script handles copying files, creating backups, and logging
# ============================================
deploy:staging:
  stage: deploy
  image: mcr.microsoft.com/powershell:latest     # PowerShell container
  script:
    - echo "Deploying to staging environment..."
    # Run deployment script with parameters
    # -Version: Application version number
    # -SourcePath: Location of published files
    # -StagingPath: Destination for deployment
    - pwsh deploy.ps1 -Version $APP_VERSION -SourcePath "./publish" -StagingPath "./deployments/staging"
    - echo "Deployment to staging completed!"
  artifacts:
    paths:
      - deployments/staging/
    expire_in: 1 month
  environment:
    name: staging
    url: https://staging.example.com
  dependencies:
    - build
  only:
    - main

# Deploy to Production - manual deployment with approval
deploy:production:
  stage: deploy
  image: mcr.microsoft.com/powershell:latest
  script:
    - echo "Deploying to production environment..."
    - pwsh deploy.ps1 -Version $APP_VERSION -SourcePath "./publish" -StagingPath "./deployments/production"
    - echo "Deployment to production completed!"
  artifacts:
    paths:
      - deployments/production/
    expire_in: 3 months
  environment:
    name: production
    url: https://production.example.com
  dependencies:
    - build
  when: manual
  only:
    - main
