# ============================================
# Lab 5 - STEP 4: Add Parallel Test Jobs
# ============================================
# Splits tests to run in parallel for faster execution
# Unit and integration tests run simultaneously

stages:
  - build
  - test
  - package

variables:
  DOTNET_VERSION: "8.0"
  DOTNET_CLI_TELEMETRY_OPTOUT: "true"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"
  DOTNET_NOLOGO: "true"
  NUGET_PACKAGES: ".nuget"

cache:
  paths:
    - .nuget/

# ============================================
# BUILD JOB
# ============================================
build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  tags:
    - kusai
  script:
    - echo "Building application..."
    - dotnet restore src/WebApi/WebApi.csproj --packages $NUGET_PACKAGES
    - dotnet build src/WebApi/WebApi.csproj --configuration Release --no-restore
    - echo "Build completed successfully!"
  artifacts:
    paths:
      - src/WebApi/bin/Release/
    expire_in: 1 hour

# ============================================
# TEST JOBS - NOW PARALLEL (BOTH RUN TOGETHER)
# ============================================
test:unit:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  tags:
    - kusai
  script:
    - echo "Running unit tests..."
    - dotnet restore tests/StatusApi.Tests/StatusApi.Tests.csproj --packages $NUGET_PACKAGES
    - dotnet test tests/StatusApi.Tests/StatusApi.Tests.csproj --configuration Release --no-restore -l "console;verbosity=detailed"
    - echo "Unit tests passed!"
  dependencies:
    - build

test:integration:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  script:
    - echo "Running integration tests..."
    - dotnet restore tests/StatusApi.Tests/StatusApi.Tests.csproj --packages $NUGET_PACKAGES
    - dotnet test tests/StatusApi.Tests/StatusApi.Tests.csproj --configuration Release --no-restore -l "console;verbosity=detailed"
    - echo "Integration tests passed!"
  dependencies:
    - build

# ============================================
# PACKAGE JOB
# ============================================
package:
  stage: package
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  tags:
    - kusai
  script:
    - echo "Creating deployment package..."
    - dotnet restore src/WebApi/WebApi.csproj --packages $NUGET_PACKAGES
    - dotnet publish src/WebApi/WebApi.csproj --configuration Release --output ./publish --no-restore
    - |
      echo "Version: $(date +%Y-%m-%d_%H:%M:%S)" > ./publish/version.txt
      echo "Commit: $CI_COMMIT_SHORT_SHA" >> ./publish/version.txt
      echo "Branch: $CI_COMMIT_REF_NAME" >> ./publish/version.txt
    - cat ./publish/version.txt
    - echo "Package created successfully!"
  artifacts:
    name: "webapi-$CI_COMMIT_SHORT_SHA"
    paths:
      - publish/
    expire_in: 1 week
  dependencies:
    - build
  only:
    - main
