# ============================================
# GitLab CI/CD Pipeline for Lab 5 - CI/CD Pipelines
# ============================================
# This pipeline demonstrates a complete deployment workflow:
# 1. BUILD: Compile and publish the Web API
# 2. TEST: Run unit tests to verify quality
# 3. DEPLOY_STAGING: Deploy to staging environment
# 4. ROLLBACK: Ability to rollback failed deployments
#
# This simulates a real production pipeline workflow
# ============================================

# Define stages (execution order)
stages:
  - build            # First: Compile the application
  - test             # Second: Run tests
  - deploy_staging   # Third: Deploy to staging
  - rollback         # Fourth: Rollback if needed

# Global variables
variables:
  DOTNET_VERSION: "8.0"                          # .NET SDK version
  DOTNET_CLI_TELEMETRY_OPTOUT: "true"           # Disable telemetry
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"     # Skip welcome messages
  DOTNET_NOLOGO: "true"                         # Hide .NET logo
  STAGING_VERSION_FILE: "staging-version.txt"   # File to track deployed version

# ============================================
# BUILD JOB - Compile and publish Web API
# ============================================
build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0        # .NET 8 SDK container
  script:
    - echo "Building Web API..."
    - dotnet restore src/WebApi/WebApi.csproj    # Download dependencies
    - dotnet build src/WebApi/WebApi.csproj --configuration Release --no-restore
    - dotnet publish src/WebApi/WebApi.csproj --configuration Release --output ./publish --no-build
    - echo "Build completed successfully!"
  artifacts:                                      # Save build outputs
    paths:
      - ./publish/                               # Published application files
      - src/WebApi/bin/Release/                  # Compiled binaries
    expire_in: 1 hour                           # Keep artifacts for 1 hour
  only:
    - main
    - merge_requests
    - branches

# ============================================
# TEST JOB - Verify application quality
# ============================================
test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - echo "Running unit tests..."
    - dotnet restore tests/StatusApi.Tests/StatusApi.Tests.csproj
    - echo "Installing JUnit logger for test reports..."
    - dotnet add tests/StatusApi.Tests/StatusApi.Tests.csproj package JunitXml.TestLogger
    - dotnet test tests/StatusApi.Tests/StatusApi.Tests.csproj --configuration Release --no-restore --logger "console;verbosity=detailed" --logger "junit;LogFileName=test-results.xml"
    - echo "All tests passed successfully!"
  artifacts:
    when: always
    paths:
      - tests/StatusApi.Tests/TestResults/test-results.xml
    reports:
      junit: tests/StatusApi.Tests/TestResults/test-results.xml
    expire_in: 7 days
  dependencies:                                   # Wait for build job
    - build
  only:
    - main
    - merge_requests
    - branches

# ============================================
# DEPLOY_STAGING JOB - Deploy to staging environment
# ============================================
# Simulates deploying to a staging server for QA testing
# In real scenarios, this would deploy to actual staging infrastructure
# ============================================
deploy_staging:
  stage: deploy_staging
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - echo "Deploying to staging environment..."
    - mkdir -p staging                           # Create staging directory
    
    # Get version from controller or set default
    - VERSION="1.0.0"
    - DEPLOYMENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
    
    # Copy artifacts to staging (simulates deployment)
    - cp -r ./publish/* staging/
    
    # Create version file for tracking deployments
    # This file helps with rollback and version tracking
    - echo "Version: $VERSION" > staging/$STAGING_VERSION_FILE
    - echo "Deployed: $DEPLOYMENT_TIME" >> staging/$STAGING_VERSION_FILE
    - echo "Commit: $CI_COMMIT_SHORT_SHA" >> staging/$STAGING_VERSION_FILE
    - echo "Branch: $CI_COMMIT_REF_NAME" >> staging/$STAGING_VERSION_FILE
    
    # Display deployment info
    - echo "========================================="
    - echo "Deployment to Staging Complete!"
    - echo "========================================="
    - cat staging/$STAGING_VERSION_FILE
    - echo "========================================="
    
    # Simulate checking deployment
    - if [ -f "staging/WebApi.dll" ]; then echo "✓ Application files deployed"; else echo "✗ Deployment failed"; exit 1; fi
  artifacts:
    paths:
      - staging/
    expire_in: 7 days
  dependencies:
    - build
  only:
    - main
  environment:
    name: staging
    action: start

# Manual rollback job
rollback:
  stage: rollback
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - echo "========================================"
    - echo "Starting Rollback Process..."
    - echo "========================================"
    
    # Check if previous version exists
    - if [ ! -f "staging/$STAGING_VERSION_FILE" ]; then
        echo "No previous deployment found to rollback to";
        exit 1;
      fi
    
    - echo "Previous deployment info:"
    - cat staging/$STAGING_VERSION_FILE
    
    # Simulate rollback by restoring previous artifacts
    # In real scenario, this would restore from backup or previous pipeline artifacts
    - echo ""
    - echo "Rollback Steps:"
    - echo "1. Stopping current application..."
    - echo "   [SIMULATED] pkill -f WebApi"
    - echo ""
    - echo "2. Restoring previous version from backup..."
    - echo "   [SIMULATED] cp -r /backup/previous-version/* staging/"
    - echo ""
    - echo "3. Updating version file..."
    - echo "Version: ROLLBACK-TO-PREVIOUS" > staging/$STAGING_VERSION_FILE
    - echo "Rollback Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> staging/$STAGING_VERSION_FILE
    - echo "Triggered By: $GITLAB_USER_NAME" >> staging/$STAGING_VERSION_FILE
    - echo ""
    - echo "4. Restarting application..."
    - echo "   [SIMULATED] systemctl restart webapi"
    - echo ""
    - echo "========================================="
    - echo "Rollback Complete!"
    - echo "========================================="
    - cat staging/$STAGING_VERSION_FILE
    - echo "========================================="
  when: manual
  dependencies:
    - deploy_staging
  only:
    - main
  environment:
    name: staging
    action: rollback
