# ============================================
# Lab 5 - STEP 5: Add Deployment Stage (FINAL)
# ============================================
# Complete pipeline with manual deployment approval
# This is the final version matching the lab guide

stages:
  - build
  - test
  - package
  - deploy_staging
  - rollback

variables:
  DOTNET_VERSION: "8.0"
  DOTNET_CLI_TELEMETRY_OPTOUT: "true"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"
  DOTNET_NOLOGO: "true"
  NUGET_PACKAGES: ".nuget"
  STAGING_VERSION_FILE: "staging-version.txt"

cache:
  paths:
    - .nuget/

# ============================================
# BUILD JOB
# ============================================
build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  tags:
    - kusai
  script:
    - echo "ðŸ”¨ Building application..."
    - dotnet restore src/WebApi/WebApi.csproj --packages $NUGET_PACKAGES
    - dotnet build src/WebApi/WebApi.csproj --configuration Release --no-restore
    - echo "âœ… Build completed successfully!"
  artifacts:
    paths:
      - src/WebApi/bin/Release/
    expire_in: 1 hour

# ============================================
# TEST JOBS - PARALLEL
# ============================================
test:unit:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  tags:
    - kusai
  script:
    - echo "ðŸ§ª Running unit tests..."
    - dotnet restore tests/StatusApi.Tests/StatusApi.Tests.csproj --packages $NUGET_PACKAGES
    - dotnet test tests/StatusApi.Tests/StatusApi.Tests.csproj --configuration Release --no-restore
    - echo "âœ… Unit tests passed!"
  dependencies:
    - build

test:integration:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  tags:
    - kusai
  script:
    - echo "ðŸ§ª Running integration tests..."
    - dotnet restore tests/StatusApi.Tests/StatusApi.Tests.csproj --packages $NUGET_PACKAGES
    - dotnet test tests/StatusApi.Tests/StatusApi.Tests.csproj --configuration Release --no-restore
    - echo "âœ… Integration tests passed!"
  dependencies:
    - build

# ============================================
# PACKAGE JOB
# ============================================
package:
  tags:
    - kusai
  stage: package
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  script:
    - echo "ðŸ“¦ Creating deployment package..."
    - dotnet restore src/WebApi/WebApi.csproj --packages $NUGET_PACKAGES
    - dotnet publish src/WebApi/WebApi.csproj --configuration Release --output ./publish --no-restore
    - |
      echo "Version: $(date +%Y-%m-%d_%H:%M:%S)" > ./publish/version.txt
      echo "Commit: $CI_COMMIT_SHORT_SHA" >> ./publish/version.txt
      echo "Branch: $CI_COMMIT_REF_NAME" >> ./publish/version.txt
    - cat ./publish/version.txt
    - echo "âœ… Package created successfully!"
  artifacts:
    name: "webapi-$CI_COMMIT_SHORT_SHA"
    paths:
      - publish/
    expire_in: 1 week
  dependencies:
    - build
  only:
    - main

# ============================================
# DEPLOY_STAGING JOB - MANUAL TRIGGER
# ============================================
# Requires manual approval before deployment
deploy_staging:
  tags:
    - kusai
  stage: deploy_staging
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  script:
    - echo "ðŸš€ Deploying to staging environment..."
    - mkdir -p staging
    - cp -r ./publish/* staging/
    - |
      echo "Version: 1.0.0" > staging/$STAGING_VERSION_FILE
      echo "Deployed: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> staging/$STAGING_VERSION_FILE
      echo "Commit: $CI_COMMIT_SHORT_SHA" >> staging/$STAGING_VERSION_FILE
      echo "Branch: $CI_COMMIT_REF_NAME" >> staging/$STAGING_VERSION_FILE
    - echo "========================================="
    - echo "âœ… Deployment to Staging Complete!"
    - echo "========================================="
    - cat staging/$STAGING_VERSION_FILE
    - echo "========================================="
    - |
      if [ -f "staging/WebApi.dll" ]; then
        echo "âœ“ Application files deployed"
      else
        echo "âœ— Deployment failed"
        exit 1
      fi
  artifacts:
    paths:
      - staging/
    expire_in: 7 days
  dependencies:
    - package
  when: manual  # Requires manual trigger
  only:
    - main
  environment:
    name: staging
    action: start

# ============================================
# ROLLBACK JOB - MANUAL TRIGGER
# ============================================
# Ability to rollback failed deployments
rollback:
  tags:
    - kusai
  stage: rollback
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  script:
    - echo "========================================"
    - echo "ðŸ”„ Starting Rollback Process..."
    - echo "========================================"
    - |
      if [ ! -f "staging/$STAGING_VERSION_FILE" ]; then
        echo "âŒ No previous deployment found to rollback to"
        exit 1
      fi
    - echo "Previous deployment info:"
    - cat staging/$STAGING_VERSION_FILE
    - echo ""
    - echo "Rollback Steps:"
    - echo "1. Stopping current application..."
    - echo "   [SIMULATED] pkill -f WebApi"
    - echo ""
    - echo "2. Restoring previous version from backup..."
    - echo "   [SIMULATED] cp -r /backup/previous-version/* staging/"
    - echo ""
    - echo "3. Updating version file..."
    - |
      echo "Version: ROLLBACK-TO-PREVIOUS" > staging/$STAGING_VERSION_FILE
      echo "Rollback Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> staging/$STAGING_VERSION_FILE
      echo "Triggered By: $GITLAB_USER_NAME" >> staging/$STAGING_VERSION_FILE
    - echo ""
    - echo "4. Restarting application..."
    - echo "   [SIMULATED] systemctl restart webapi"
    - echo ""
    - echo "========================================="
    - echo "âœ… Rollback Complete!"
    - echo "========================================="
    - cat staging/$STAGING_VERSION_FILE
    - echo "========================================="
  when: manual
  dependencies:
    - deploy_staging
  only:
    - main
  environment:
    name: staging
    action: stop