# ============================================
# Lab 5 - STEP 2: Add Caching for Performance
# ============================================
# Enhanced version with NuGet caching to speed up builds
# This reduces pipeline execution time significantly

stages:
  - build
  - test

variables:
  DOTNET_VERSION: "8.0"
  DOTNET_CLI_TELEMETRY_OPTOUT: "true"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"
  DOTNET_NOLOGO: "true"
  NUGET_PACKAGES: ".nuget"  # Cache location for NuGet packages

# Global cache configuration
cache:
  paths:
    - .nuget/

# ============================================
# BUILD JOB - With Caching
# ============================================
build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  script:
    - echo "Building application..."
    - dotnet restore src/WebApi/WebApi.csproj --packages $NUGET_PACKAGES
    - dotnet build src/WebApi/WebApi.csproj --configuration Release --no-restore
    - echo "Build completed successfully!"
  artifacts:
    paths:
      - src/WebApi/bin/Release/
    expire_in: 1 hour

# ============================================
# TEST JOB
# ============================================
test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  script:
    - echo "Running tests..."
    - dotnet restore tests/StatusApi.Tests/StatusApi.Tests.csproj --packages $NUGET_PACKAGES
    - dotnet test tests/StatusApi.Tests/StatusApi.Tests.csproj --configuration Release --no-restore
    - echo "Tests passed!"
  dependencies:
    - build
