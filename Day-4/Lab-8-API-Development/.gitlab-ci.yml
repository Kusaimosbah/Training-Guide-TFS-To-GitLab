# ============================================
# GitLab CI/CD Pipeline for Lab 8 - API Development
# ============================================
# Complete CI/CD pipeline for Capstone Web API
# Pipeline stages: BUILD ‚Üí TEST ‚Üí DEPLOY_STAGING ‚Üí QUALITY_GATE ‚Üí ROLLBACK
# Demonstrates professional API development workflow with quality checks
# ============================================

# Define pipeline stages
stages:
  - build              # First: Compile and publish API
  - test              # Second: Run all tests
  - deploy_staging    # Third: Deploy to Ubuntu server
  - rollback          # Fourth: Manual rollback if needed

# Global variables
variables:
  DOTNET_VERSION: "8.0"                          # .NET SDK version
  PROJECT_PATH: "src/CapstoneApi/CapstoneApi.csproj"  # API project path
  TEST_PATH: "tests/CapstoneApi.Tests/CapstoneApi.Tests.csproj"  # Test project path
  ARTIFACTS_PATH: "publish"                      # Output directory
  DEPLOY_SERVER: "139.59.248.22"                 # Ubuntu server IP (shared by all trainees)
  DEPLOY_PORT: "5000"                            # Port for this trainee (change per trainee: 5001, 5002, 5003...)
  DEPLOY_USER: "root"                            # Server username (can be overridden by CI/CD Variable)
  DEPLOY_PATH: "/opt/capstone-api"               # Deployment path on server
  # DEPLOY_PASSWORD is REQUIRED as a Protected/Masked CI/CD Variable in GitLab UI
  # DO NOT hardcode credentials in git - use GitLab CI/CD Variables instead!

# ============================================
# BUILD JOB - Compile and publish Web API
# ============================================
build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0        # .NET 8 SDK
  tags:
    - kusai
  script:
    - echo "üî® Building Capstone API..."
    - dotnet restore $PROJECT_PATH               # Restore NuGet packages
    - dotnet build $PROJECT_PATH --configuration Release --no-restore
    - dotnet publish $PROJECT_PATH --configuration Release --output $ARTIFACTS_PATH --no-build
    - echo "‚úÖ Build completed successfully"
  artifacts:                                      # Save published API
    paths:
      - $ARTIFACTS_PATH/                         # Published application
    expire_in: 1 hour                           # Short retention for staging
  only:
    - main
    - develop
    - merge_requests

# ============================================
# TEST JOB - Run unit and integration tests
# ============================================
test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  tags:
    - kusai
  script: |
    echo "üß™ Running unit and integration tests..."
    dotnet restore $TEST_PATH
    echo "Installing JUnit logger for test reports..."
    dotnet add $TEST_PATH package JunitXml.TestLogger
    dotnet test $TEST_PATH --configuration Release --no-restore --logger "console;verbosity=normal" --logger "junit;LogFileName=test-results.xml"
    echo "‚úÖ All tests passed"
  artifacts:                                      # Save test results
    when: always                                 # Save even if tests fail
    paths:
      - tests/CapstoneApi.Tests/TestResults/test-results.xml
    reports:                                     # GitLab test report integration
      junit: tests/CapstoneApi.Tests/TestResults/test-results.xml
    expire_in: 7 days
  dependencies:
    - build
  only:
    - main
    - develop
    - merge_requests

# ============================================
# DEPLOY_STAGING JOB - Deploy to Ubuntu server
# ============================================
# Deploys the API to the production Ubuntu server via SSH
# Server: 139.59.248.22, Port: 5000
# ============================================
deploy_staging:
  stage: deploy_staging
  image: alpine:latest
  tags:
    - kusai
  before_script:
    - apk add --no-cache openssh-client sshpass
  script: |
    echo "üöÄ Deploying to Ubuntu server: $DEPLOY_SERVER:$DEPLOY_PORT..."
    # Validate required variables
    if [ -z "$DEPLOY_PASSWORD" ]; then
      echo "‚ùå ERROR: DEPLOY_PASSWORD CI/CD Variable not set in GitLab"
      echo "Please set it in: Settings ‚Üí CI/CD ‚Üí Variables"
      exit 1
    fi
    if [ -z "$DEPLOY_USER" ]; then
      echo "‚ùå ERROR: DEPLOY_USER CI/CD Variable not set"
      exit 1
    fi
    echo "‚úÖ Credentials validated"
    # Create deployment directory on server if it doesn't exist
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "mkdir -p $DEPLOY_PATH"
    echo "‚úÖ Deployment directory ready"
    # Copy published artifacts to server
    echo "üì¶ Uploading API artifacts..."
    sshpass -p "$DEPLOY_PASSWORD" scp -o StrictHostKeyChecking=no -r $ARTIFACTS_PATH/* $DEPLOY_USER@$DEPLOY_SERVER:$DEPLOY_PATH/
    echo "‚úÖ Artifacts uploaded"
    # Stop previous API instance on this port if running
    echo "üõë Stopping previous API instance on port $DEPLOY_PORT..."
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "lsof -i :$DEPLOY_PORT | grep -v COMMAND | awk '{print \$2}' | xargs -r kill -9 2>/dev/null || true"
    sleep 2
    # Start the new API with ASPNETCORE_URLS set to the correct port
    echo "üöÄ Starting Capstone API on port $DEPLOY_PORT..."
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "nohup /opt/capstone-api/CapstoneApi --urls=http://0.0.0.0:$DEPLOY_PORT > /opt/capstone-api/api-$DEPLOY_PORT.log 2>&1 &"
    sleep 3
    echo "‚úÖ Deployment completed successfully"
    echo "üìå API accessible at: http://$DEPLOY_SERVER:$DEPLOY_PORT/swagger"
    echo "üìå Health check: http://$DEPLOY_SERVER:$DEPLOY_PORT/api/status/health"
  artifacts:
    paths:
      - $ARTIFACTS_PATH/
    expire_in: 7 days
  environment:
    name: production
    url: http://139.59.248.22:5000/swagger
  dependencies:
    - build
    - test
  only:
    - main

# ============================================
# ROLLBACK_STAGING JOB - Restore previous version (MANUAL)
# ============================================
# Manually triggered to rollback staging deployment
# Restores backup if available
# ============================================
rollback_staging:
  stage: rollback
  image: mcr.microsoft.com/dotnet/sdk:8.0
  tags:
    - kusai
  script:
    - echo "‚è™ Rolling back staging deployment..."
    - echo "Restoring previous version from backup..."
    # Check if backup exists, then restore
    - |
      if [ -d "backups/staging-backup" ]; then
        rm -rf staging                           # Remove current deployment
        cp -r backups/staging-backup staging     # Restore backup
        echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ") - Rollback completed" >> staging/rollback-info.txt
        echo "‚úÖ Rollback completed successfully"
      else
        echo "‚ùå No backup found - cannot rollback"
        exit 1
      fi
  when: manual                                   # Must be triggered manually
  environment:
    name: staging
    url: https://gitlab.allen-ly.online/git-workshop-2025/capstone-api/pipelines
  only:
    - main
