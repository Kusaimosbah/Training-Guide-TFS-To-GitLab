# ============================================
# GitLab CI/CD Pipeline for Lab 11 - SonarCloud Code Quality
# ============================================
# Demonstrates professional code quality scanning with SonarCloud
# Scans the CapstoneApi project from Lab 10
# Pipeline stages: BUILD â†’ TEST â†’ SONARCLOUD â†’ ARCHIVE
# Enforces quality gates before deployment
# ============================================

# Define pipeline stages
stages:
  - build              # First: Compile and publish
  - test              # Second: Run all tests
  - sonarcloud        # Third: Code quality & security scan
  - deploy_staging    # Fourth: Archive artifacts

# Global variables
variables:
  DOTNET_VERSION: "8.0"                          # .NET SDK version
  PROJECT_PATH: "src/CapstoneApi/CapstoneApi.csproj"  # Local API project
  TEST_PATH: "tests/CapstoneApi.Tests/CapstoneApi.Tests.csproj"  # Local tests
  ARTIFACTS_PATH: "publish"                      # Output directory
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"   # SonarCloud cache location
  GIT_DEPTH: "0"                                 # Full clone for SCM blame data
  RUNNER_TAG: "kusai"                            # GitLab runner tag

# ============================================
# BUILD JOB - Compile and publish Web API
# ============================================
build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0
  tags:
    - $RUNNER_TAG
  script:
    - echo "ðŸ”¨ Building CapstoneApi..."
    - dotnet restore $PROJECT_PATH
    - dotnet build $PROJECT_PATH --configuration Release --no-restore
    - dotnet publish $PROJECT_PATH --configuration Release --no-build --output $ARTIFACTS_PATH
    - echo "âœ… Build completed successfully!"
  artifacts:
    paths:
      - $ARTIFACTS_PATH/
    expire_in: 1 hour
  only:
    - main
    - merge_requests
    - branches

# ============================================
# TEST JOB - Run all unit and integration tests
# ============================================
test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  tags:
    - $RUNNER_TAG
  script:
    - echo "ðŸ§ª Running tests..."
    - dotnet restore "$TEST_PATH"
    - dotnet test "$TEST_PATH" --configuration Release --no-restore --logger:trx --results-directory tests/CapstoneApi.Tests/TestResults
    - mkdir -p tests/CapstoneApi.Tests/TestResults
    - find tests/CapstoneApi.Tests/TestResults -name "*.trx" -exec mv {} tests/CapstoneApi.Tests/TestResults/test-results.xml \;
    - echo "âœ… All tests passed!"
  artifacts:
    when: always
    paths:
      - tests/CapstoneApi.Tests/TestResults/test-results.xml
    reports:
      junit: tests/CapstoneApi.Tests/TestResults/test-results.xml
    expire_in: 7 days
  dependencies:
    - build
  only:
    - main
    - merge_requests
    - branches

# ============================================
# SONARCLOUD JOB - Code Quality & Security Scan
# ============================================
# Performs static code analysis with SonarCloud:
# - Detects bugs, vulnerabilities, code smells
# - Calculates code coverage from tests
# - Enforces quality gate (blocks merge if fails)
# - Uploads results to https://sonarcloud.io
# ============================================
sonarcloud-scan:
  stage: sonarcloud
  image: mcr.microsoft.com/dotnet/sdk:8.0
  tags:
    - $RUNNER_TAG
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache                             # Cache SonarCloud data for faster scans
  before_script:
    - echo "ðŸ” Installing SonarScanner for .NET..."
    - dotnet tool install --global dotnet-sonarscanner
    - export PATH="$PATH:$HOME/.dotnet/tools"
  script:
    - echo "âœ… SonarScanner installed"
    
    - echo "ðŸ”§ Restoring dependencies..."
    - dotnet restore $PROJECT_PATH
    - dotnet restore $TEST_PATH
    
    - echo "ðŸ“Š Starting SonarCloud analysis..."
    - |
      dotnet sonarscanner begin \
        /k:"capstone-api" \
        /o:"kusai" \
        /d:sonar.host.url="https://sonarcloud.io" \
        /d:sonar.login="${SONAR_TOKEN}" \
        /d:sonar.branch.name=master
    
    - echo "ðŸ”¨ Building project for analysis..."
    - dotnet build $PROJECT_PATH --configuration Release --no-restore
    - dotnet build $TEST_PATH --configuration Release --no-restore
    
    - echo "ðŸ§ª Running tests..."
    - dotnet test "$TEST_PATH" --configuration Release --no-restore
    
    - echo "ðŸ“¤ Uploading results to SonarCloud..."
    - dotnet sonarscanner end /d:sonar.login="${SONAR_TOKEN}"
    
    - echo "SonarCloud analysis complete!"
    - echo "View results at https://sonarcloud.io/dashboard for capstone-api"
  allow_failure: false                           # BLOCK pipeline if quality gate fails
  needs:
    - build
    - test
  only:
    - main                                       # Run on main branch
    - merge_requests                             # Run on merge requests

# ============================================
# DEPLOY:STAGING JOB - Archive build artifacts (after SonarCloud passes)
# ============================================
deploy:staging:
  stage: deploy_staging
  image: mcr.microsoft.com/dotnet/sdk:8.0
  tags:
    - $RUNNER_TAG
  script:
    - echo "ðŸ“¦ Archiving build artifacts..."
    - mkdir -p staging
    - cp -r $ARTIFACTS_PATH/* staging/
    - echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ") - Version 1.0.$CI_PIPELINE_ID" > staging/build-info.txt
    - echo "âœ… Artifacts archived successfully"
    - echo "Build quality passed SonarCloud gate"
  artifacts:
    paths:
      - staging/
    expire_in: 7 days
  needs:
    - build
    - test
    - sonarcloud-scan
  only:
    - main

# ============================================
# NOTES FOR TRAINEES
# ============================================
# 1. Replace "your-organization-key" with your actual SonarCloud organization key
# 2. Set SONAR_TOKEN and SONAR_HOST_URL in GitLab CI/CD Variables:
#    - SONAR_TOKEN: Your SonarCloud token (masked)
#    - SONAR_HOST_URL: https://sonarcloud.io
# 3. Quality gate will FAIL the pipeline if:
#    - New bugs are introduced
#    - New vulnerabilities are found
#    - Code coverage drops below threshold
#    - Too many code smells are added
# 4. View detailed analysis at: https://sonarcloud.io/dashboard?id=capstone-api
