# ============================================
# GitLab CI/CD Pipeline for Lab 9 - Integration Testing
# ============================================
# GOAL: Demonstrate complete CI/CD pipeline with separated testing strategy
# Pipeline stages: BUILD â†’ UNIT-TEST â†’ INTEGRATION-TEST â†’ DEPLOY
# - Separates fast unit tests from slower integration tests (parallel execution)
# - Deploys to real Ubuntu server if all tests pass
# - Each trainee uses a different port (5001, 5002, 5003...) for concurrent deployment
# - Accessible from browser: http://139.59.248.22:{PORT}/swagger
# ============================================

# Define pipeline stages
stages:
  - build              # First: Compile and publish
  - unit-test         # Second: Fast unit tests
  - integration-test  # Third: Full API integration tests
  - deploy            # Fourth: Deploy to staging

# Global variables
variables:
  DOTNET_VERSION: "8.0"                          # .NET SDK version
  DOTNET_CLI_TELEMETRY_OPTOUT: "true"           # Disable telemetry
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"     # Skip welcome
  DOTNET_NOLOGO: "true"                         # Hide logo
  PROJECT_PATH: "src/CapstoneApi/CapstoneApi.csproj"  # API project path
  TEST_PATH: "tests/CapstoneApi.Tests/CapstoneApi.Tests.csproj"  # Test project path
  ARTIFACTS_PATH: "publish"                      # Output directory
  DEPLOY_SERVER: "139.59.248.22"                 # Ubuntu server IP (shared by all trainees)
  DEPLOY_PORT: "5001"                            # Port for this trainee (change per trainee: 5002, 5003, 5004...)
  DEPLOY_USER: "root"                            # Server username
  DEPLOY_PATH: "/opt/capstone-api"               # Base deployment path on server
  DEPLOY_DIR: "/opt/capstone-api/${DEPLOY_PORT}" # Port-specific directory (isolated per trainee)
  APP_VERSION: "1.0.0"                          # Application version
  RUNNER_TAG: "kusai"                            # GitLab runner tag
  # DEPLOY_PASSWORD is REQUIRED as a Protected/Masked CI/CD Variable in GitLab UI

# ============================================
# BUILD JOB - Compile and publish API
# ============================================
build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0        # .NET 8 SDK
  tags:
    - $RUNNER_TAG
  script:
    - echo "ðŸ”¨ Building Capstone API..."
    - dotnet restore $PROJECT_PATH -r linux-x64  # Restore with linux-x64 runtime
    - dotnet build $PROJECT_PATH --configuration Release --no-restore -r linux-x64
    - echo "ðŸ“¦ Publishing as self-contained binary (Linux x64)..."
    - dotnet publish $PROJECT_PATH --configuration Release --output $ARTIFACTS_PATH --self-contained --runtime linux-x64
    - echo "âœ… Build completed successfully"
  artifacts:                                      # Save build outputs
    paths:
      - $ARTIFACTS_PATH/                         # Published application
    expire_in: 1 hour                            # Short retention for staging
  only:
    - main
    - merge_requests
    - branches

# ============================================
# UNIT-TEST JOB - Fast service layer tests
# ============================================
# Tests individual services and business logic
# Runs quickly without dependencies or infrastructure
# ============================================
unit-test:
  stage: unit-test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  tags:
    - $RUNNER_TAG
  script: |
    echo "ðŸ§ª Running unit tests..."
    dotnet restore $TEST_PATH
    echo "Installing JUnit logger for test reports..."
    dotnet add $TEST_PATH package JunitXml.TestLogger
    dotnet test $TEST_PATH --filter "FullyQualifiedName~Unit" --configuration Release --logger "console;verbosity=normal" --logger "junit;LogFileName=unit-test-results.xml" --no-restore
    echo "âœ… Unit tests passed"
  artifacts:
    when: always
    paths:
      - tests/CapstoneApi.Tests/TestResults/unit-test-results.xml
    reports:
      junit: tests/CapstoneApi.Tests/TestResults/unit-test-results.xml
    expire_in: 7 days
  dependencies:
    - build
  only:
    - main
    - merge_requests
    - branches

# ============================================
# INTEGRATION-TEST JOB - Full API end-to-end tests
# ============================================
# Tests complete API with WebApplicationFactory
# Spins up in-memory test server for HTTP requests
# Tests controllers, routing, middleware, and full request/response cycle
# ============================================
integration-test:
  stage: integration-test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  tags:
    - $RUNNER_TAG
  script: |
    echo "ðŸ§ª Running integration tests..."
    dotnet restore $TEST_PATH
    echo "Installing JUnit logger for test reports..."
    dotnet add $TEST_PATH package JunitXml.TestLogger
    dotnet test $TEST_PATH --filter "FullyQualifiedName~Integration" --configuration Release --logger "console;verbosity=normal" --logger "junit;LogFileName=integration-test-results.xml" --no-restore
    echo "âœ… Integration tests passed"
  artifacts:
    when: always
    paths:
      - tests/CapstoneApi.Tests/TestResults/integration-test-results.xml
    reports:
      junit: tests/CapstoneApi.Tests/TestResults/integration-test-results.xml
    expire_in: 7 days
  dependencies:
    - build
  only:
    - main
    - merge_requests
    - branches

# ============================================
# DEPLOY_STAGING JOB - Deploy to Ubuntu server
# ============================================
# Deploys the API to the Ubuntu server via SSH
# Server: 139.59.248.22
# ============================================
deploy_staging:
  stage: deploy
  image: alpine:latest
  tags:
    - $RUNNER_TAG
  before_script:
    - apk add --no-cache openssh-client sshpass
  script: |
    echo "ðŸš€ Deploying to Ubuntu server: $DEPLOY_SERVER:$DEPLOY_PORT..."
    # Validate required variables
    if [ -z "$DEPLOY_PASSWORD" ]; then
      echo "âŒ ERROR: DEPLOY_PASSWORD CI/CD Variable not set in GitLab"
      echo "Please set it in: Settings â†’ CI/CD â†’ Variables"
      exit 1
    fi
    if [ -z "$DEPLOY_USER" ]; then
      echo "âŒ ERROR: DEPLOY_USER CI/CD Variable not set"
      exit 1
    fi
    echo "âœ… Credentials validated"
    # Stop previous API instance on this port if running
    echo "ðŸ›‘ Stopping previous API instance on port $DEPLOY_PORT..."
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "lsof -i :$DEPLOY_PORT | grep -v COMMAND | awk '{print \$2}' | xargs -r kill -9 2>/dev/null || true"
    sleep 3
    # Remove old deployment for this specific port (isolated per trainee)
    echo "ðŸ§¹ Cleaning up old deployment for port $DEPLOY_PORT..."
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "rm -rf $DEPLOY_DIR 2>/dev/null || true"
    sleep 1
    # Create port-specific deployment directory (no conflicts between trainees)
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "mkdir -p $DEPLOY_DIR"
    echo "âœ… Deployment directory ready"
    # Copy published artifacts to server
    echo "ðŸ“¦ Uploading API artifacts..."
    sshpass -p "$DEPLOY_PASSWORD" scp -o StrictHostKeyChecking=no -r $ARTIFACTS_PATH/* $DEPLOY_USER@$DEPLOY_SERVER:$DEPLOY_DIR/
    echo "âœ… Artifacts uploaded"
    # Make the binary executable
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "chmod +x $DEPLOY_DIR/CapstoneApi"
    echo "âœ… Binary permissions set"
    # Start the new API with ASPNETCORE_URLS set to the correct port
    echo "ðŸš€ Starting Capstone API on port $DEPLOY_PORT..."
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "nohup $DEPLOY_DIR/CapstoneApi --urls=http://0.0.0.0:$DEPLOY_PORT > $DEPLOY_DIR/api.log 2>&1 &"
    sleep 3
    echo "âœ… Deployment completed successfully"
    echo "ðŸ“Œ API accessible at: http://$DEPLOY_SERVER:$DEPLOY_PORT/swagger"
    echo "ðŸ“Œ Health check: http://$DEPLOY_SERVER:$DEPLOY_PORT/api/status/health"
  artifacts:
    paths:
      - $ARTIFACTS_PATH/
    expire_in: 7 days
  environment:
    name: staging
    url: http://$DEPLOY_SERVER:$DEPLOY_PORT/swagger
  dependencies:
    - build
    - unit-test
    - integration-test
  only:
    - main
