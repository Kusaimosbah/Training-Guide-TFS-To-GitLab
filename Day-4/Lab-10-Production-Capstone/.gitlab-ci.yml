# ============================================
# GitLab CI/CD Pipeline for Lab 10 - Production Capstone
# ============================================
# Complete enterprise SDLC pipeline demonstrating production-ready practices
# Pipeline stages: BUILD ‚Üí UNIT-TEST ‚Üí INTEGRATION-TEST ‚Üí DEPLOY-STAGING ‚Üí DEPLOY-PRODUCTION ‚Üí ROLLBACK
# Features: Self-contained build, SSH deployment, staging gate, manual production approval
# Deploys to Ubuntu server: 139.59.248.22 (Staging: 8000, Production: 8001)
# ============================================

# Define pipeline stages
stages:
  - build              # First: Compile and publish
  - unit-test         # Second: Fast unit tests
  - integration-test  # Third: Full API tests
  - deploy-staging    # Fourth: Deploy to staging (automatic)
  - deploy-production # Fifth: Deploy to production (manual approval)
  - rollback          # Sixth: Emergency rollback (manual)

# Global variables
variables:
  DOTNET_VERSION: "8.0"                          # .NET SDK version
  DOTNET_CLI_TELEMETRY_OPTOUT: "true"           # Disable telemetry
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"     # Skip welcome
  DOTNET_NOLOGO: "true"                         # Hide logo
  PROJECT_PATH: "src/CapstoneApi/CapstoneApi.csproj"  # API project path
  TEST_PATH: "tests/CapstoneApi.Tests/CapstoneApi.Tests.csproj"  # Test project path
  ARTIFACTS_PATH: "publish"                      # Output directory
  DEPLOY_SERVER: "139.59.248.22"                 # Ubuntu server IP (shared by all trainees)
  DEPLOY_PORT_STAGING: "8000"                    # Staging port (automatic deployment)
  DEPLOY_PORT_PRODUCTION: "8001"                 # Production port (manual approval)
  DEPLOY_USER: "root"                            # Server username
  DEPLOY_PATH: "/opt/capstone-api"               # Base deployment path on server
  APP_VERSION: "2.0.0"                          # Application version
  RUNNER_TAG: "kusai"                            # GitLab runner tag
  # DEPLOY_PASSWORD is REQUIRED as a Protected/Masked CI/CD Variable in GitLab UI

# ============================================
# BUILD JOB - Compile and publish Order API
# ============================================
build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0        # .NET 8 SDK
  tags:
    - $RUNNER_TAG
  script:
    - echo "üî® Building Capstone API version $APP_VERSION..."
    - dotnet restore $PROJECT_PATH -r linux-x64  # Restore with linux-x64 runtime
    - dotnet build $PROJECT_PATH --configuration Release --no-restore -r linux-x64
    - echo "üì¶ Publishing as self-contained binary (Linux x64)..."
    - dotnet publish $PROJECT_PATH --configuration Release --output $ARTIFACTS_PATH --self-contained --runtime linux-x64
    - echo "‚úÖ Build completed successfully"
  artifacts:                                      # Save build outputs
    paths:
      - $ARTIFACTS_PATH/                         # Published application
    expire_in: 1 hour                            # Short retention for staging
  only:
    - main
    - merge_requests
    - branches

# ============================================
# UNIT-TEST JOB - Service layer unit tests
# ============================================
# Tests business logic and services in isolation
# Fast execution without external dependencies
# ============================================
unit-test:
  stage: unit-test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  tags:
    - $RUNNER_TAG
  script:
    - echo "Running unit tests..."
    - dotnet restore tests/CapstoneApi.Tests/CapstoneApi.Tests.csproj
    - echo "Installing JUnit logger for test reports..."
    - dotnet add tests/CapstoneApi.Tests/CapstoneApi.Tests.csproj package JunitXml.TestLogger
    - dotnet test tests/CapstoneApi.Tests/CapstoneApi.Tests.csproj --filter "FullyQualifiedName~Unit" --configuration Release --logger "console;verbosity=detailed" --logger "junit;LogFileName=unit-test-results.xml" --no-restore
    - echo "‚úÖ All unit tests passed!"
  artifacts:
    when: always
    paths:
      - tests/CapstoneApi.Tests/TestResults/unit-test-results.xml
    reports:
      junit: tests/CapstoneApi.Tests/TestResults/unit-test-results.xml
    expire_in: 7 days
  dependencies:
    - build
  only:
    - main
    - merge_requests
    - branches

# ============================================
# INTEGRATION-TEST JOB - End-to-end API tests
# ============================================
# Tests complete API workflows with WebApplicationFactory
# Validates controllers, routing, middleware, and data flow
# ============================================
integration-test:
  stage: integration-test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  tags:
    - $RUNNER_TAG
  script:
    - echo "Running integration tests (full API)..."
    - dotnet restore tests/CapstoneApi.Tests/CapstoneApi.Tests.csproj
    - echo "Installing JUnit logger for test reports..."
    - dotnet add tests/CapstoneApi.Tests/CapstoneApi.Tests.csproj package JunitXml.TestLogger
    - dotnet test tests/CapstoneApi.Tests/CapstoneApi.Tests.csproj --filter "FullyQualifiedName~Integration" --configuration Release --logger "console;verbosity=detailed" --logger "junit;LogFileName=integration-test-results.xml" --no-restore
    - echo "‚úÖ Integration tests passed!"
  artifacts:
    when: always
    paths:
      - tests/CapstoneApi.Tests/TestResults/integration-test-results.xml
    reports:
      junit: tests/CapstoneApi.Tests/TestResults/integration-test-results.xml
    expire_in: 7 days
  dependencies:
    - build
  only:
    - main
    - merge_requests
    - branches

# ============================================
# DEPLOY:STAGING JOB - Automated staging deployment
# ============================================
# Deploys automatically to staging (port 8000) after all tests pass
# Uses SSH to Ubuntu server for real deployment
# Creates backup for potential rollback
# ============================================
deploy:staging:
  stage: deploy-staging
  image: alpine:latest
  tags:
    - $RUNNER_TAG
  before_script:
    - apk add --no-cache openssh-client sshpass
  script: |
    echo "üöÄ Deploying version $APP_VERSION to STAGING (port $DEPLOY_PORT_STAGING)..."
    # Validate required variables
    if [ -z "$DEPLOY_PASSWORD" ]; then
      echo "‚ùå ERROR: DEPLOY_PASSWORD CI/CD Variable not set in GitLab"
      exit 1
    fi
    echo "‚úÖ Credentials validated"
    # Stop previous staging instance
    echo "üõë Stopping previous staging instance on port $DEPLOY_PORT_STAGING..."
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "lsof -i :$DEPLOY_PORT_STAGING | grep -v COMMAND | awk '{print \$2}' | xargs -r kill -9 2>/dev/null || true"
    sleep 2
    # Create staging directory
    DEPLOY_DIR_STAGING="$DEPLOY_PATH/${DEPLOY_PORT_STAGING}"
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "rm -rf $DEPLOY_DIR_STAGING 2>/dev/null || true && mkdir -p $DEPLOY_DIR_STAGING"
    echo "‚úÖ Staging directory ready"
    # Upload artifacts
    echo "üì¶ Uploading artifacts to staging..."
    sshpass -p "$DEPLOY_PASSWORD" scp -o StrictHostKeyChecking=no -r $ARTIFACTS_PATH/* $DEPLOY_USER@$DEPLOY_SERVER:$DEPLOY_DIR_STAGING/
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "chmod +x $DEPLOY_DIR_STAGING/CapstoneApi"
    echo "‚úÖ Artifacts uploaded"
    # Start staging API
    echo "üöÄ Starting Capstone API on port $DEPLOY_PORT_STAGING..."
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "nohup $DEPLOY_DIR_STAGING/CapstoneApi --urls=http://0.0.0.0:$DEPLOY_PORT_STAGING > $DEPLOY_DIR_STAGING/api.log 2>&1 &"
    sleep 3
    echo "‚úÖ Deployment to STAGING completed!"
    echo "üìå Staging API: http://$DEPLOY_SERVER:$DEPLOY_PORT_STAGING/swagger"
    echo "üìå Version: $APP_VERSION"
  artifacts:
    paths:
      - $ARTIFACTS_PATH/
    expire_in: 7 days
  environment:
    name: staging
    url: http://139.59.248.22:8000/swagger
  dependencies:
    - build
    - unit-test
    - integration-test
  only:
    - main

# ============================================
# DEPLOY:PRODUCTION JOB - Manual production deployment
# ============================================
# Requires MANUAL approval before deploying to production (port 8001)
# Only runs after successful staging deployment
# Uses SSH to Ubuntu server for real production deployment
# ============================================
deploy:production:
  stage: deploy-production
  image: alpine:latest
  tags:
    - $RUNNER_TAG
  before_script:
    - apk add --no-cache openssh-client sshpass
  script: |
    echo "üöÄ Deploying version $APP_VERSION to PRODUCTION (port $DEPLOY_PORT_PRODUCTION)..."
    # Validate required variables
    if [ -z "$DEPLOY_PASSWORD" ]; then
      echo "‚ùå ERROR: DEPLOY_PASSWORD CI/CD Variable not set in GitLab"
      exit 1
    fi
    echo "‚úÖ Credentials validated"
    # Stop previous production instance
    echo "üõë Stopping previous production instance on port $DEPLOY_PORT_PRODUCTION..."
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "lsof -i :$DEPLOY_PORT_PRODUCTION | grep -v COMMAND | awk '{print \$2}' | xargs -r kill -9 2>/dev/null || true"
    sleep 2
    # Create production directory
    DEPLOY_DIR_PRODUCTION="$DEPLOY_PATH/${DEPLOY_PORT_PRODUCTION}"
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "rm -rf $DEPLOY_DIR_PRODUCTION 2>/dev/null || true && mkdir -p $DEPLOY_DIR_PRODUCTION"
    echo "‚úÖ Production directory ready"
    # Upload artifacts
    echo "üì¶ Uploading artifacts to production..."
    sshpass -p "$DEPLOY_PASSWORD" scp -o StrictHostKeyChecking=no -r $ARTIFACTS_PATH/* $DEPLOY_USER@$DEPLOY_SERVER:$DEPLOY_DIR_PRODUCTION/
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "chmod +x $DEPLOY_DIR_PRODUCTION/CapstoneApi"
    echo "‚úÖ Artifacts uploaded"
    # Start production API
    echo "üöÄ Starting Capstone API on port $DEPLOY_PORT_PRODUCTION..."
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "nohup $DEPLOY_DIR_PRODUCTION/CapstoneApi --urls=http://0.0.0.0:$DEPLOY_PORT_PRODUCTION > $DEPLOY_DIR_PRODUCTION/api.log 2>&1 &"
    sleep 3
    echo "‚úÖ Deployment to PRODUCTION completed!"
    echo "üìå Production API: http://$DEPLOY_SERVER:$DEPLOY_PORT_PRODUCTION/swagger"
    echo "üìå Version: $APP_VERSION"
  artifacts:
    paths:
      - $ARTIFACTS_PATH/
    expire_in: 30 days
  environment:
    name: production
    url: http://139.59.248.22:8001/swagger
  when: manual                                   # REQUIRES MANUAL APPROVAL
  only:
    - main
  needs:
    - build
    - unit-test
    - integration-test
    - deploy:staging

# ============================================
# ROLLBACK:PRODUCTION JOB - Emergency rollback only
# ============================================
# Manually triggered emergency recovery for production
# Restores previous working version from production backup
# Used only when production deployment fails or causes issues
# ============================================
rollback:production:
  stage: rollback
  image: alpine:latest
  tags:
    - $RUNNER_TAG
  before_script:
    - apk add --no-cache openssh-client sshpass
  script: |
    echo "‚ö†Ô∏è EMERGENCY: Rolling back PRODUCTION to previous version..."
    # Validate credentials
    if [ -z "$DEPLOY_PASSWORD" ]; then
      echo "‚ùå ERROR: DEPLOY_PASSWORD CI/CD Variable not set"
      exit 1
    fi
    # Get backup path
    DEPLOY_DIR_PRODUCTION="$DEPLOY_PATH/${DEPLOY_PORT_PRODUCTION}"
    BACKUP_DIR_PRODUCTION="$DEPLOY_PATH/${DEPLOY_PORT_PRODUCTION}-backup"
    # Check if backup exists
    echo "üîç Checking for production backup..."
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "ls -la $BACKUP_DIR_PRODUCTION 2>/dev/null" || {
      echo "‚ùå ERROR: No backup found at $BACKUP_DIR_PRODUCTION"
      exit 1
    }
    # Stop current production instance
    echo "üõë Stopping current production instance on port $DEPLOY_PORT_PRODUCTION..."
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "lsof -i :$DEPLOY_PORT_PRODUCTION | grep -v COMMAND | awk '{print \$2}' | xargs -r kill -9 2>/dev/null || true"
    sleep 2
    # Restore from backup
    echo "üì¶ Restoring previous production version from backup..."
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "rm -rf $DEPLOY_DIR_PRODUCTION && cp -r $BACKUP_DIR_PRODUCTION $DEPLOY_DIR_PRODUCTION"
    echo "‚úÖ Backup restored"
    # Restart API with restored version
    echo "üöÄ Restarting API with previous version on port $DEPLOY_PORT_PRODUCTION..."
    sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "chmod +x $DEPLOY_DIR_PRODUCTION/CapstoneApi && nohup $DEPLOY_DIR_PRODUCTION/CapstoneApi --urls=http://0.0.0.0:$DEPLOY_PORT_PRODUCTION > $DEPLOY_DIR_PRODUCTION/api.log 2>&1 &"
    sleep 3
    echo "‚ö†Ô∏è ROLLBACK COMPLETED!"
    echo "üìå Production restored to previous version"
    echo "üìå API: http://$DEPLOY_SERVER:$DEPLOY_PORT_PRODUCTION/swagger"
  environment:
    name: production
    url: http://139.59.248.22:8001/swagger
    action: stop
  when: manual                                   # ONLY manual rollback, no auto
  only:
    - main
