# ============================================
# GitLab CI/CD Pipeline for Lab 12
# Security Scanning (SAST + DAST) & Variables
# ============================================
# This pipeline demonstrates:
# 1. GitLab Variables (global, job-level, masked, protected)
# 2. SAST scanning with SonarCloud (static code analysis)
# 3. Dependency scanning with Snyk
# 4. Secret scanning to prevent leaks
# 5. DAST with OWASP ZAP (dynamic app security testing)
# ============================================

stages:
  - build
  - test
  - sast              # Static Application Security Testing
  - dependency        # Dependency vulnerability scanning
  - secret            # Detect accidentally committed secrets
  - deploy            # Deploy to staging
  - dast              # Dynamic Application Security Testing
  - report            # Security summary report

# ============================================
# GLOBAL VARIABLES - Available to all jobs
# ============================================
# These demonstrate variable usage patterns
variables:
  # Configuration variables (not secrets)
  DOTNET_VERSION: "8.0"
  BUILD_CONFIG: "Release"
  PROJECT_NAME: "CapstoneApi"
  ARTIFACT_RETENTION: "7 days"
  LOG_LEVEL: "INFO"
  
  # Security tool configurations
  SONAR_HOST_URL: "https://sonarcloud.io"      # Public SonarCloud URL
  # SONAR_TOKEN: Set in Settings ‚Üí CI/CD ‚Üí Variables (masked + protected)
  # SNYK_TOKEN: Set in Settings ‚Üí CI/CD ‚Üí Variables (masked + protected)
  
  # DAST configuration
  DAST_ENABLED: "true"
  DAST_TIMEOUT: "1800"                         # 30 minutes
  
  # Environment URLs
  STAGING_URL: "https://staging.example.com"
  
  # GitLab built-in variable override for shallow clone
  GIT_DEPTH: "0"                               # Full clone for better analysis

# ============================================
# BUILD JOB - Compile application
# ============================================
build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  variables:
    # Job-level variables (only in this job)
    BUILD_OUTPUT: "build-output"
  script:
    - echo "üî® Building $PROJECT_NAME with .NET $DOTNET_VERSION"
    - echo "Configuration: $BUILD_CONFIG"
    
    - dotnet restore src/CapstoneApi/CapstoneApi.csproj
    - dotnet build src/CapstoneApi/CapstoneApi.csproj --configuration $BUILD_CONFIG
    - dotnet publish src/CapstoneApi/CapstoneApi.csproj --configuration $BUILD_CONFIG --output $BUILD_OUTPUT
    
    - echo "‚úÖ Build completed successfully!"
  artifacts:
    paths:
      - $BUILD_OUTPUT/
    expire_in: $ARTIFACT_RETENTION
  only:
    - main
    - merge_requests
    - branches

# ============================================
# TEST JOBS - Run unit and integration tests
# ============================================
test:unit:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  variables:
    TEST_FILTER: "Unit"           # Job-level variable
  script:
    - echo "üß™ Running $TEST_FILTER tests..."
    - dotnet test tests/CapstoneApi.Tests/CapstoneApi.Tests.csproj 
        --filter "FullyQualifiedName~${TEST_FILTER}" 
        --configuration $BUILD_CONFIG
  dependencies:
    - build
  only:
    - main
    - merge_requests
    - branches

test:integration:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  variables:
    TEST_FILTER: "Integration"    # Different value, same variable name
  script:
    - echo "üß™ Running $TEST_FILTER tests..."
    - dotnet test tests/CapstoneApi.Tests/CapstoneApi.Tests.csproj 
        --filter "FullyQualifiedName~${TEST_FILTER}" 
        --configuration $BUILD_CONFIG
  dependencies:
    - build
  only:
    - main
    - merge_requests
    - branches

# ============================================
# SAST JOB - Static code analysis with SonarCloud
# ============================================
sast:sonarcloud:
  stage: sast
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - echo "üîç Starting SonarCloud SAST (Static) Analysis..."
    - echo "Project: $CI_PROJECT_NAME"
    - echo "Branch: $CI_COMMIT_REF_NAME"
    - echo "Commit: $CI_COMMIT_SHORT_SHA"
    
    - dotnet tool install --global dotnet-sonarscanner
    - export PATH="$PATH:$HOME/.dotnet/tools"
    
    - apt-get update && apt-get install -y openjdk-17-jre-headless
    
    - |
      dotnet sonarscanner begin \
        /k:"capstone-api" \
        /o:"your-organization-key" \
        /d:sonar.host.url="${SONAR_HOST_URL}" \
        /d:sonar.token="${SONAR_TOKEN}"
    
    - dotnet build src/CapstoneApi/CapstoneApi.csproj --configuration $BUILD_CONFIG
    - dotnet sonarscanner end /d:sonar.token="${SONAR_TOKEN}"
    
    - echo "‚úÖ SonarCloud analysis uploaded!"
  dependencies:
    - build
  allow_failure: false
  only:
    - main
    - merge_requests

# ============================================
# DEPENDENCY SCANNING - Detect vulnerable NuGet packages
# ============================================
dependency_scanning:snyk:
  stage: dependency
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  variables:
    SNYK_SEVERITY: "high"         # Fail on high severity
  script:
    - echo "üì¶ Scanning dependencies for vulnerabilities..."
    - echo "Severity threshold: $SNYK_SEVERITY"
    
    - npm install -g snyk
    - snyk auth ${SNYK_TOKEN}     # Uses masked variable
    
    - snyk test --severity-threshold=${SNYK_SEVERITY} \
        --json > dependency-report.json || true
    
    - echo "‚úÖ Dependency scan complete!"
  artifacts:
    paths:
      - dependency-report.json
    reports:
      dependency_scanning: dependency-report.json
    expire_in: 30 days
  allow_failure: true              # Report but don't fail pipeline
  only:
    - main
    - merge_requests

# ============================================
# SECRET SCANNING - Detect leaked credentials
# ============================================
secret_scanning:trufflehog:
  stage: secret
  image: python:3.9
  script:
    - echo "üîê Scanning git history for secrets..."
    
    - pip install truffleHog3 --quiet
    - trufflehog git file://. --json > secret-report.json || true
    
    - echo "‚ö†Ô∏è  Any secrets found must be revoked immediately!"
    - cat secret-report.json | head -20  # Show first 20 lines
  artifacts:
    paths:
      - secret-report.json
    expire_in: 30 days
  allow_failure: true               # Alert but don't block
  only:
    - main
    - merge_requests

# ============================================
# DEPLOY:STAGING - Deploy to staging environment
# ============================================
# Note: This is simplified. Real deployment uses scripts or tools.
deploy:staging:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}
  variables:
    DEPLOY_ENV: "staging"
    DEPLOY_TIMEOUT: "300"
  environment:
    name: staging
    url: https://staging.example.com
  script:
    - echo "üöÄ Deploying to $DEPLOY_ENV environment..."
    - echo "Timeout: $DEPLOY_TIMEOUT seconds"
    - echo "Built with: $DOTNET_VERSION"
    
    # In real world, use PowerShell/Bash scripts:
    # - powershell deploy.ps1 -Environment $DEPLOY_ENV -Version $CI_COMMIT_SHORT_SHA
    - echo "‚úÖ Deployment to $DEPLOY_ENV completed!"
  dependencies:
    - build
    - test:unit
    - test:integration
    - sast:sonarcloud
  allow_failure: false
  only:
    - main

# ============================================
# DAST JOB - Dynamic app security testing with OWASP ZAP
# ============================================
# DAST tests the RUNNING application
# Requires staging deployment to be running first
dast:owasp-zap:
  stage: dast
  image: owasp/zap2docker-stable:latest
  variables:
    ZAP_REPORT_FORMAT: "xml"
    ZAP_REPORT_FILE: "zap-report.xml"
    TARGET_PROTOCOL: "https"       # Or http for staging
    RULES_FILE: "/root/rules.tsv"
  script:
    - echo "üîì Starting OWASP ZAP DAST (Dynamic) Security Test..."
    - echo "Target: ${TARGET_PROTOCOL}://${STAGING_URL}"
    - echo "Report: $ZAP_REPORT_FILE"
    
    # Baseline scan (faster, less aggressive)
    - |
      zaproxy \
        -cmd \
        -quickurl "${TARGET_PROTOCOL}://${STAGING_URL}:5000" \
        -quickout "$ZAP_REPORT_FILE"
    
    - echo "‚úÖ DAST scan complete!"
    - ls -lh "$ZAP_REPORT_FILE"
  artifacts:
    paths:
      - $ZAP_REPORT_FILE
    reports:
      dast: $ZAP_REPORT_FILE
    expire_in: 30 days
  dependencies:
    - deploy:staging              # Only run after deploy succeeds
  allow_failure: false             # Fail if critical vulns found
  only:
    - main
    - merge_requests
  retry:
    max: 1
    when: script_failure

# ============================================
# SECURITY REPORT JOB - Summarize all findings
# ============================================
security_report:
  stage: report
  image: alpine:latest
  script:
    - echo ""
    - echo "======================================"
    - echo "üìä SECURITY SCAN SUMMARY"
    - echo "======================================"
    - echo "Pipeline: $CI_PIPELINE_ID"
    - echo "Project: $CI_PROJECT_NAME"
    - echo "Branch: $CI_COMMIT_REF_NAME"
    - echo "Commit: $CI_COMMIT_SHORT_SHA"
    - echo ""
    - echo "‚úÖ SAST (Static Code Analysis):"
    - echo "   Tool: SonarCloud"
    - echo "   Status: See SonarCloud dashboard"
    - echo ""
    - echo "üì¶ DEPENDENCY SCANNING:"
    - echo "   Tool: Snyk"
    - echo "   Report: dependency-report.json"
    - echo ""
    - echo "üîê SECRET SCANNING:"
    - echo "   Tool: TruffleHog"
    - echo "   Report: secret-report.json"
    - echo ""
    - echo "üîì DAST (Dynamic App Testing):"
    - echo "   Tool: OWASP ZAP"
    - echo "   Report: zap-report.xml"
    - echo ""
    - echo "======================================"
    - echo "All security scans complete!"
    - echo "======================================"
  dependencies:
    - dependency_scanning:snyk
    - secret_scanning:trufflehog
    - dast:owasp-zap
  only:
    - main
    - merge_requests

# ============================================
# NOTES FOR TRAINEES
# ============================================
# 1. GLOBAL VARIABLES:
#    - Available to all jobs
#    - Reduce code duplication
#    - Example: DOTNET_VERSION, BUILD_CONFIG
#
# 2. JOB-LEVEL VARIABLES:
#    - Override global variables in specific jobs
#    - Example: TEST_FILTER changes per job
#
# 3. MASKED VARIABLES (in Settings ‚Üí CI/CD ‚Üí Variables):
#    - Hidden in pipeline logs
#    - Example: SONAR_TOKEN, SNYK_TOKEN
#    - Set flag: ‚úÖ Masked
#
# 4. PROTECTED VARIABLES:
#    - Only available on protected branches (main)
#    - Example: Production credentials
#    - Set flag: ‚úÖ Protected
#
# 5. CI PREDEFINED VARIABLES (built-in):
#    - $CI_PROJECT_NAME - Project name
#    - $CI_COMMIT_SHA - Full commit hash
#    - $CI_COMMIT_SHORT_SHA - Short commit hash
#    - $CI_COMMIT_REF_NAME - Branch name
#    - $CI_PIPELINE_ID - Pipeline ID
#    - $CI_JOB_NAME - Current job name
#
# 6. SAST vs DAST:
#    SAST (Static):
#    - Analyzes SOURCE CODE without running
#    - Fast (1-5 minutes)
#    - Examples: SonarCloud, Snyk
#    
#    DAST (Dynamic):
#    - Tests RUNNING APPLICATION
#    - Slow (5-30 minutes)
#    - Examples: OWASP ZAP, Burp Suite
#
# 7. SECURITY BEST PRACTICES:
#    - Always mask secrets
#    - Always protect prod vars
#    - Use both SAST and DAST
#    - Scan dependencies
#    - Detect secret leaks
#    - Fail on critical vulns
